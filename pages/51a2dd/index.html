<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《Swift编程语言》- 自动引用计数 | zhmbo</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/MouseClickEffect.js"></script>
    <script src="/js/FooterFish.js"></script>
    <meta name="description" content="zhmbo的技术博客,专注iOS技术分享,iOS,OC,Objective-C,Swift,SwiftUI,Apple,上架,Flutter,OpenGL,Xcode,Github,RxSwift,算法,架构,面试,zhmbo,zb,ZB,zhmbo,jumbo">
    <meta name="keywords" content="zhmbo,zhmbo,zhangbao,zhmbo的技术博客,个人博客,博客搭建,专注iOS技术分享,iOS,iOS进阶,iOS高级,OC,Objective-C,Swift,SwiftUI,Apple,上架,Flutter,OpenGL,Xcode,RxSwift,UIButton,UITableView,网络请求,Github,GithubActions,算法,架构,面试,zb,ZB,zhmbo,jumbo">
    <meta name="baidu-site-verification" content="code-l7ZsTFnxp5">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.8e525da2.css" as="style"><link rel="preload" href="/assets/js/app.f91ba302.js" as="script"><link rel="preload" href="/assets/js/2.dd713b59.js" as="script"><link rel="preload" href="/assets/js/3.069de0ac.js" as="script"><link rel="preload" href="/assets/js/36.ef1f9b0b.js" as="script"><link rel="prefetch" href="/assets/js/10.eca7f202.js"><link rel="prefetch" href="/assets/js/100.884f2e2c.js"><link rel="prefetch" href="/assets/js/101.77e3c5d7.js"><link rel="prefetch" href="/assets/js/102.fbb46419.js"><link rel="prefetch" href="/assets/js/103.4285ab2f.js"><link rel="prefetch" href="/assets/js/104.b9d45e83.js"><link rel="prefetch" href="/assets/js/105.9af86ee7.js"><link rel="prefetch" href="/assets/js/106.f8baee69.js"><link rel="prefetch" href="/assets/js/107.fa4c186a.js"><link rel="prefetch" href="/assets/js/108.155cdba8.js"><link rel="prefetch" href="/assets/js/11.d5dc511b.js"><link rel="prefetch" href="/assets/js/12.126fd524.js"><link rel="prefetch" href="/assets/js/13.31add050.js"><link rel="prefetch" href="/assets/js/14.8f5927ce.js"><link rel="prefetch" href="/assets/js/15.5d73bb50.js"><link rel="prefetch" href="/assets/js/16.b7715387.js"><link rel="prefetch" href="/assets/js/17.b3336126.js"><link rel="prefetch" href="/assets/js/18.f0bd764d.js"><link rel="prefetch" href="/assets/js/19.7f321d7b.js"><link rel="prefetch" href="/assets/js/20.8a704687.js"><link rel="prefetch" href="/assets/js/21.6c9b4fd0.js"><link rel="prefetch" href="/assets/js/22.ce92c244.js"><link rel="prefetch" href="/assets/js/23.cbae088c.js"><link rel="prefetch" href="/assets/js/24.64936988.js"><link rel="prefetch" href="/assets/js/25.6ff36218.js"><link rel="prefetch" href="/assets/js/26.192e5aa3.js"><link rel="prefetch" href="/assets/js/27.5d49847d.js"><link rel="prefetch" href="/assets/js/28.865bfa0a.js"><link rel="prefetch" href="/assets/js/29.652b637f.js"><link rel="prefetch" href="/assets/js/30.2d2405ab.js"><link rel="prefetch" href="/assets/js/31.ff15975d.js"><link rel="prefetch" href="/assets/js/32.319807cb.js"><link rel="prefetch" href="/assets/js/33.b87269c8.js"><link rel="prefetch" href="/assets/js/34.2c88022c.js"><link rel="prefetch" href="/assets/js/35.090f353e.js"><link rel="prefetch" href="/assets/js/37.ba5ce128.js"><link rel="prefetch" href="/assets/js/38.3c99d047.js"><link rel="prefetch" href="/assets/js/39.20a400e2.js"><link rel="prefetch" href="/assets/js/4.39a2702d.js"><link rel="prefetch" href="/assets/js/40.0f612174.js"><link rel="prefetch" href="/assets/js/41.c39b1818.js"><link rel="prefetch" href="/assets/js/42.73cd76fc.js"><link rel="prefetch" href="/assets/js/43.fec22db6.js"><link rel="prefetch" href="/assets/js/44.24cf9514.js"><link rel="prefetch" href="/assets/js/45.1a7bd4ad.js"><link rel="prefetch" href="/assets/js/46.2772e34b.js"><link rel="prefetch" href="/assets/js/47.b4eeef41.js"><link rel="prefetch" href="/assets/js/48.6e849ea1.js"><link rel="prefetch" href="/assets/js/49.e0c5a13d.js"><link rel="prefetch" href="/assets/js/5.5d94312a.js"><link rel="prefetch" href="/assets/js/50.773364d5.js"><link rel="prefetch" href="/assets/js/51.1db99b25.js"><link rel="prefetch" href="/assets/js/52.8c4dc63b.js"><link rel="prefetch" href="/assets/js/53.ebf1abab.js"><link rel="prefetch" href="/assets/js/54.016f21d7.js"><link rel="prefetch" href="/assets/js/55.73199a2d.js"><link rel="prefetch" href="/assets/js/56.3316e67d.js"><link rel="prefetch" href="/assets/js/57.57c6a9d7.js"><link rel="prefetch" href="/assets/js/58.65589959.js"><link rel="prefetch" href="/assets/js/59.abcabc64.js"><link rel="prefetch" href="/assets/js/6.8a416018.js"><link rel="prefetch" href="/assets/js/60.d382d1c3.js"><link rel="prefetch" href="/assets/js/61.c76620c7.js"><link rel="prefetch" href="/assets/js/62.44f03a5b.js"><link rel="prefetch" href="/assets/js/63.92fa470c.js"><link rel="prefetch" href="/assets/js/64.2475bc0a.js"><link rel="prefetch" href="/assets/js/65.e33c22e2.js"><link rel="prefetch" href="/assets/js/66.b213e189.js"><link rel="prefetch" href="/assets/js/67.54079f5f.js"><link rel="prefetch" href="/assets/js/68.9490fd8d.js"><link rel="prefetch" href="/assets/js/69.c9253eff.js"><link rel="prefetch" href="/assets/js/7.369ac24e.js"><link rel="prefetch" href="/assets/js/70.1c59f92a.js"><link rel="prefetch" href="/assets/js/71.3492471a.js"><link rel="prefetch" href="/assets/js/72.cec16c5f.js"><link rel="prefetch" href="/assets/js/73.50e8862b.js"><link rel="prefetch" href="/assets/js/74.086f16c5.js"><link rel="prefetch" href="/assets/js/75.5554210f.js"><link rel="prefetch" href="/assets/js/76.dfb35acc.js"><link rel="prefetch" href="/assets/js/77.440dde49.js"><link rel="prefetch" href="/assets/js/78.22d12fc4.js"><link rel="prefetch" href="/assets/js/79.7805a9b0.js"><link rel="prefetch" href="/assets/js/8.dd8ea451.js"><link rel="prefetch" href="/assets/js/80.0f6e99d9.js"><link rel="prefetch" href="/assets/js/81.775865b4.js"><link rel="prefetch" href="/assets/js/82.b0a6a6bc.js"><link rel="prefetch" href="/assets/js/83.b4431f89.js"><link rel="prefetch" href="/assets/js/84.9266dd31.js"><link rel="prefetch" href="/assets/js/85.6250c179.js"><link rel="prefetch" href="/assets/js/86.8def8d74.js"><link rel="prefetch" href="/assets/js/87.ae604169.js"><link rel="prefetch" href="/assets/js/88.ea0b4861.js"><link rel="prefetch" href="/assets/js/89.86dbd55a.js"><link rel="prefetch" href="/assets/js/9.d1ab447d.js"><link rel="prefetch" href="/assets/js/90.9225e7d0.js"><link rel="prefetch" href="/assets/js/91.f6bbf533.js"><link rel="prefetch" href="/assets/js/92.a7f31cba.js"><link rel="prefetch" href="/assets/js/93.540860df.js"><link rel="prefetch" href="/assets/js/94.2e3d73ab.js"><link rel="prefetch" href="/assets/js/95.e35292b9.js"><link rel="prefetch" href="/assets/js/96.c8174b05.js"><link rel="prefetch" href="/assets/js/97.f7b36c87.js"><link rel="prefetch" href="/assets/js/98.555706b2.js"><link rel="prefetch" href="/assets/js/99.70b5aa9a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8e525da2.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu have-body-img"><header class="navbar blur"><div class="width-limit"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link"><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/202407311741918.png" alt="zhmbo" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont jumbo-nav-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="iOS" class="dropdown-title"><a href="/ios/" class="link-title"><i class="iconfont jumbo-apple"></i>
      iOS
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-apple"></i>
      iOS
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>iOS开发精髓</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/3f0170/" class="nav-link"><i class="iconfont undefined"></i>
  介绍
</a></li><li class="dropdown-subitem"><a href="/pages/7354af/" class="nav-link"><i class="iconfont undefined"></i>
  从入门
</a></li><li class="dropdown-subitem"><a href="/pages/1b29d1/" class="nav-link"><i class="iconfont undefined"></i>
  到放弃
</a></li></ul></li><li class="dropdown-item"><h4>iOS充电宝</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/5cb5f0/" class="nav-link"><i class="iconfont undefined"></i>
  SwiftUI
</a></li><li class="dropdown-subitem"><a href="/pages/9e761f/" class="nav-link"><i class="iconfont undefined"></i>
  iOS14
</a></li><li class="dropdown-subitem"><a href="/pages/5e2170/" class="nav-link"><i class="iconfont undefined"></i>
  Xcode12
</a></li><li class="dropdown-subitem"><a href="/pages/554b82/" class="nav-link"><i class="iconfont undefined"></i>
  iOS周边
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Swift" class="dropdown-title"><a href="/swift/" class="link-title"><i class="iconfont jumbo-swift"></i>
      Swift
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-swift"></i>
      Swift
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/04ed05/" class="nav-link"><i class="iconfont undefined"></i>
  概览
</a></li><li class="dropdown-item"><!----> <a href="/pages/cf2b9a/" class="nav-link"><i class="iconfont undefined"></i>
  欢迎来到Swift
</a></li><li class="dropdown-item"><!----> <a href="/pages/9e2f81/" class="nav-link"><i class="iconfont undefined"></i>
  Swift语法
</a></li><li class="dropdown-item"><!----> <a href="/pages/581348/" class="nav-link"><i class="iconfont undefined"></i>
  语言参考
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title"><i class="iconfont jumbo-jishu"></i>
      技术
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-jishu"></i>
      技术
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4f2c93/" class="nav-link"><i class="iconfont undefined"></i>
  博客
</a></li><li class="dropdown-item"><!----> <a href="/pages/6cbba7/" class="nav-link"><i class="iconfont undefined"></i>
  Github
</a></li><li class="dropdown-item"><!----> <a href="/pages/d9a627/" class="nav-link"><i class="iconfont undefined"></i>
  CocosCreator
</a></li><li class="dropdown-item"><!----> <a href="/pages/9af5e1/" class="nav-link"><i class="iconfont undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/pages/46944a/" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/pages/4b617e/" class="nav-link"><i class="iconfont undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/pages/6ee1a4/" class="nav-link"><i class="iconfont undefined"></i>
  Git
</a></li></ul></div></div><div class="nav-item"><a href="/leaveword/" class="nav-link"><i class="iconfont jumbo-liuyan"></i>
  留言
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title"><i class="iconfont jumbo-suoyin"></i>
      索引
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-suoyin"></i>
      索引
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link"><i class="iconfont undefined"></i>
  分类
</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link"><i class="iconfont undefined"></i>
  标签
</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link"><i class="iconfont undefined"></i>
  归档
</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link"><i class="iconfont undefined"></i>
  友链
</a></li><li class="dropdown-item"><!----> <a href="/navigation/" class="nav-link"><i class="iconfont undefined"></i>
  导航
</a></li><li class="dropdown-item"><!----> <a href="/findme/" class="nav-link"><i class="iconfont undefined"></i>
  寻Me
</a></li></ul></div></div> <!----></nav></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20200919111632.png"> <div class="blogger-info"><h3>@jumbo</h3> <span>an ios developer</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link"><i class="iconfont jumbo-nav-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="iOS" class="dropdown-title"><a href="/ios/" class="link-title"><i class="iconfont jumbo-apple"></i>
      iOS
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-apple"></i>
      iOS
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>iOS开发精髓</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/3f0170/" class="nav-link"><i class="iconfont undefined"></i>
  介绍
</a></li><li class="dropdown-subitem"><a href="/pages/7354af/" class="nav-link"><i class="iconfont undefined"></i>
  从入门
</a></li><li class="dropdown-subitem"><a href="/pages/1b29d1/" class="nav-link"><i class="iconfont undefined"></i>
  到放弃
</a></li></ul></li><li class="dropdown-item"><h4>iOS充电宝</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/5cb5f0/" class="nav-link"><i class="iconfont undefined"></i>
  SwiftUI
</a></li><li class="dropdown-subitem"><a href="/pages/9e761f/" class="nav-link"><i class="iconfont undefined"></i>
  iOS14
</a></li><li class="dropdown-subitem"><a href="/pages/5e2170/" class="nav-link"><i class="iconfont undefined"></i>
  Xcode12
</a></li><li class="dropdown-subitem"><a href="/pages/554b82/" class="nav-link"><i class="iconfont undefined"></i>
  iOS周边
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Swift" class="dropdown-title"><a href="/swift/" class="link-title"><i class="iconfont jumbo-swift"></i>
      Swift
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-swift"></i>
      Swift
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/04ed05/" class="nav-link"><i class="iconfont undefined"></i>
  概览
</a></li><li class="dropdown-item"><!----> <a href="/pages/cf2b9a/" class="nav-link"><i class="iconfont undefined"></i>
  欢迎来到Swift
</a></li><li class="dropdown-item"><!----> <a href="/pages/9e2f81/" class="nav-link"><i class="iconfont undefined"></i>
  Swift语法
</a></li><li class="dropdown-item"><!----> <a href="/pages/581348/" class="nav-link"><i class="iconfont undefined"></i>
  语言参考
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术" class="dropdown-title"><a href="/technology/" class="link-title"><i class="iconfont jumbo-jishu"></i>
      技术
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-jishu"></i>
      技术
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4f2c93/" class="nav-link"><i class="iconfont undefined"></i>
  博客
</a></li><li class="dropdown-item"><!----> <a href="/pages/6cbba7/" class="nav-link"><i class="iconfont undefined"></i>
  Github
</a></li><li class="dropdown-item"><!----> <a href="/pages/d9a627/" class="nav-link"><i class="iconfont undefined"></i>
  CocosCreator
</a></li><li class="dropdown-item"><!----> <a href="/pages/9af5e1/" class="nav-link"><i class="iconfont undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/pages/46944a/" class="nav-link"><i class="iconfont undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/pages/4b617e/" class="nav-link"><i class="iconfont undefined"></i>
  Android
</a></li><li class="dropdown-item"><!----> <a href="/pages/6ee1a4/" class="nav-link"><i class="iconfont undefined"></i>
  Git
</a></li></ul></div></div><div class="nav-item"><a href="/leaveword/" class="nav-link"><i class="iconfont jumbo-liuyan"></i>
  留言
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title"><i class="iconfont jumbo-suoyin"></i>
      索引
    </a> <span class="title" style="display:none;"><i class="iconfont jumbo-suoyin"></i>
      索引
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link"><i class="iconfont undefined"></i>
  分类
</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link"><i class="iconfont undefined"></i>
  标签
</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link"><i class="iconfont undefined"></i>
  归档
</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link"><i class="iconfont undefined"></i>
  友链
</a></li><li class="dropdown-item"><!----> <a href="/navigation/" class="nav-link"><i class="iconfont undefined"></i>
  导航
</a></li><li class="dropdown-item"><!----> <a href="/findme/" class="nav-link"><i class="iconfont undefined"></i>
  寻Me
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/04ed05/" class="sidebar-link">概览</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>欢迎来到Swift</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Swift语法</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/9e2f81/" class="sidebar-link">基础知识</a></li><li><a href="/pages/279dd7/" class="sidebar-link">基本运算符</a></li><li><a href="/pages/2850e8/" class="sidebar-link">字符串和字符</a></li><li><a href="/pages/4b4c78/" class="sidebar-link">集合类型</a></li><li><a href="/pages/544cb0/" class="sidebar-link">控制流</a></li><li><a href="/pages/b69d99/" class="sidebar-link">函数</a></li><li><a href="/pages/7904a7/" class="sidebar-link">闭包</a></li><li><a href="/pages/56276f/" class="sidebar-link">枚举</a></li><li><a href="/pages/0641bb/" class="sidebar-link">类和结构体</a></li><li><a href="/pages/ce0459/" class="sidebar-link">属性</a></li><li><a href="/pages/efc653/" class="sidebar-link">方法</a></li><li><a href="/pages/e35887/" class="sidebar-link">下标</a></li><li><a href="/pages/09b0f4/" class="sidebar-link">继承</a></li><li><a href="/pages/1b072a/" class="sidebar-link">构造过程</a></li><li><a href="/pages/c40911/" class="sidebar-link">解析过程</a></li><li><a href="/pages/96b368/" class="sidebar-link">可选链</a></li><li><a href="/pages/cc5b2d/" class="sidebar-link">错误处理</a></li><li><a href="/pages/757c02/" class="sidebar-link">类型转换</a></li><li><a href="/pages/1d43f5/" class="sidebar-link">嵌套类型</a></li><li><a href="/pages/297d1c/" class="sidebar-link">扩展</a></li><li><a href="/pages/82f958/" class="sidebar-link">协议</a></li><li><a href="/pages/0d8a5e/" class="sidebar-link">泛型</a></li><li><a href="/pages/46ff18/" class="sidebar-link">不透明类型</a></li><li><a href="/pages/51a2dd/" aria-current="page" class="active sidebar-link">自动引用计数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/51a2dd/#自动引用计数的工作机制" class="sidebar-link">自动引用计数的工作机制</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#自动引用计数实践" class="sidebar-link">自动引用计数实践</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#类实例之间的循环强引用" class="sidebar-link">类实例之间的循环强引用</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#解决实例之间的循环强引用" class="sidebar-link">解决实例之间的循环强引用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/51a2dd/#弱引用" class="sidebar-link">弱引用</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#无主引用" class="sidebar-link">无主引用</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#无主引用和隐式解包可选值属性" class="sidebar-link">无主引用和隐式解包可选值属性</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#闭包的循环强引用" class="sidebar-link">闭包的循环强引用</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#解决闭包的循环强引用" class="sidebar-link">解决闭包的循环强引用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/51a2dd/#定义捕获列表" class="sidebar-link">定义捕获列表</a></li><li class="sidebar-sub-header"><a href="/pages/51a2dd/#弱引用和无主引用" class="sidebar-link">弱引用和无主引用</a></li></ul></li></ul></li><li><a href="/pages/9224f8/" class="sidebar-link">内存安全</a></li><li><a href="/pages/6c25a0/" class="sidebar-link">访问控制</a></li><li><a href="/pages/9854b9/" class="sidebar-link">高级运算符</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>语言参考</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"> <div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-7e90c5a4><div class="articleInfo" data-v-7e90c5a4><ul class="breadcrumbs" data-v-7e90c5a4><li data-v-7e90c5a4><a href="/" title="首页" class="iconfont jumbo-home router-link-active" data-v-7e90c5a4></a></li> <li data-v-7e90c5a4><a href="/categories/?category=Swift%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" title="分类" data-v-7e90c5a4>Swift编程语言</a></li> <li data-v-7e90c5a4><a href="/categories/?category=Swift%E8%AF%AD%E6%B3%95" title="分类" data-v-7e90c5a4>Swift语法</a></li></ul> <div class="info" data-v-7e90c5a4><div title="作者" class="author iconfont jumbo-author" data-v-7e90c5a4><a href="https://github.com/zhmbo" target="_blank" title="作者" class="beLink" data-v-7e90c5a4>zhmbo</a></div> <div title="创建时间" class="date iconfont jumbo-time" data-v-7e90c5a4><a href="javascript:;" data-v-7e90c5a4>2020-11-10</a></div> <div title="统计" class="date iconfont jumbo-eye" data-v-7e90c5a4><span id="/pages/51a2dd/" data-flag-title="《Swift编程语言》- 自动引用计数" class="leancloud-visitors" data-v-7e90c5a4><a class="leancloud-visitors-count" style="font-size:.7rem;font-weight:normal;color:#999;"></a></span></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          《Swift编程语言》- 自动引用计数
        </h1> <div class="theme-vdoing-content content__default"><p>Swift 使用<em>自动引用计数（ARC）</em> 机制来跟踪和管理你的应用程序的内存。通常情况下，Swift 内存管理机制会一直起作用，你无须自己来考虑内存的管理。ARC 会在类的实例不再被使用时，自动释放其占用的内存。</p> <p>然而在少数情况下，为了能帮助你管理内存，ARC 需要更多的，代码之间关系的信息。本章描述了这些情况，并且为你示范怎样才能使 ARC 来管理你的应用程序的所有内存。在 Swift 使用 ARC 与在 Obejctive-C 中使用 ARC 非常类似，具体请参考 <a href="https://developer.apple.com/library/content/releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html#//apple-ref/doc/uid/TP40011226" target="_blank" rel="noopener noreferrer">过渡到 ARC 的发布说明<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <blockquote><p>注意</p> <p>引用计数仅仅应用于类的实例。结构体和枚举类型是值类型，不是引用类型，也不是通过引用的方式存储和传递。</p></blockquote> <h2 id="自动引用计数的工作机制"><a href="#自动引用计数的工作机制" class="header-anchor">#</a> 自动引用计数的工作机制</h2> <p>每当你创建一个新的类实例时，ARC 会分配一块内存来储存该实例的信息。内存中会包含实例的类型信息，以及这个实例所关联的任何存储属性的值。</p> <p>此外，当实例不再被使用时，ARC 释放实例所占用的内存，并让释放的内存能挪作他用。这确保了不再被使用的实例，不会一直占用内存空间。</p> <p>然而，当 ARC 回收并释放了正在被使用中的实例后，该实例的属性和方法将不能再被访问和调用。实际上，如果你试图访问这个实例，你的应用程序很可能会崩溃。</p> <p>为了确保使用中的实例不会被销毁，ARC 会跟踪和计算每一个实例正在被多少属性，常量和变量所引用。哪怕实例的引用数为 1，ARC 都不会销毁这个实例。</p> <p>为了使上述成为可能，无论你将实例赋值给属性、常量或变量，它们都会创建此实例的强引用。之所以称之为“强”引用，是因为它会将实例牢牢地保持住，只要强引用还在，实例是不允许被销毁的。</p> <h2 id="自动引用计数实践"><a href="#自动引用计数实践" class="header-anchor">#</a> 自动引用计数实践</h2> <p>下面的例子展示了自动引用计数的工作机制。例子以一个简单的 <code>Person</code> 类开始，并定义了一个叫 <code>name</code> 的常量属性：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being initialized&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>Person</code> 类有一个构造器，此构造器给实例的 <code>name</code> 属性赋值，并打印一条消息以表明初始化过程生效。<code>Person</code> 类也拥有一个析构器，这个析构器会在实例被销毁时打印一条消息。</p> <p>接下来的代码片段定义了三个类型为 <code>Person?</code> 的变量，按照代码片段中的顺序，为新的 <code>Person</code> 实例建立多个引用。由于这些变量是被定义为可选类型（<code>Person?</code>，而不是 <code>Person</code>），它们的值会被自动初始化为 <code>nil</code>，目前还不会引用到 <code>Person</code> 类的实例。</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> reference1<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
<span class="token keyword">var</span> reference2<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
<span class="token keyword">var</span> reference3<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在你可以创建 <code>Person</code> 类的新实例，并且将它赋值给三个变量中的一个：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>reference1 <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;John Appleseed&quot;</span></span><span class="token punctuation">)</span>
<span class="token comment">// 打印“John Appleseed is being initialized”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>应当注意到当你调用 <code>Person</code> 类的构造器的时候，<code>&quot;John Appleseed is being initialized&quot;</code> 会被打印出来。由此可以确定构造器被执行。</p> <p>由于 <code>Person</code> 类的新实例被赋值给了 <code>reference1</code> 变量，所以 <code>reference1</code> 到 <code>Person</code> 类的新实例之间建立了一个强引用。正是因为这一个强引用，ARC 会保证 <code>Person</code> 实例被保持在内存中不被销毁。</p> <p>如果你将同一个 <code>Person</code> 实例也赋值给其他两个变量，该实例又会多出两个强引用：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>reference2 <span class="token operator">=</span> reference1
reference3 <span class="token operator">=</span> reference1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在这一个 <code>Person</code> 实例已经有三个强引用了。</p> <p>如果你通过给其中两个变量赋值 <code>nil</code> 的方式断开两个强引用（包括最先的那个强引用），只留下一个强引用，<code>Person</code> 实例不会被销毁：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>reference1 <span class="token operator">=</span> <span class="token nil constant">nil</span>
reference2 <span class="token operator">=</span> <span class="token nil constant">nil</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在你清楚地表明不再使用这个 <code>Person</code> 实例时，即第三个也就是最后一个强引用被断开时，ARC 会销毁它：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>reference3 <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token comment">// 打印“John Appleseed is being deinitialized”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="类实例之间的循环强引用"><a href="#类实例之间的循环强引用" class="header-anchor">#</a> 类实例之间的循环强引用</h2> <p>在上面的例子中，ARC 会跟踪你所新创建的 <code>Person</code> 实例的引用数量，并且会在 <code>Person</code> 实例不再被需要时销毁它。</p> <p>然而，我们可能会写出一个类实例的强引用数<em>永远不能</em>变成 <code>0</code> 的代码。如果两个类实例互相持有对方的强引用，因而每个实例都让对方一直存在，就是这种情况。这就是所谓的<em>循环强引用</em>。</p> <p>你可以通过定义类之间的关系为弱引用或无主引用，来替代强引用，从而解决循环强引用的问题。具体的过程在 <a href="#%E8%A7%A3%E5%86%B3%E5%AE%9E%E4%BE%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%BC%BA%E5%BC%95%E7%94%A8">解决实例之间的循环强引用</a> 中有描述。不管怎样，在你学习怎样解决循环强引用之前，很有必要了解一下它是怎样产生的。</p> <p>下面展示了一个不经意产生循环强引用的例子。例子定义了两个类：<code>Person</code> 和 <code>Apartment</code>，用来建模公寓和它其中的居民：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token punctuation">}</span>
    <span class="token keyword">var</span> apartment<span class="token punctuation">:</span> <span class="token class-name">Apartment</span><span class="token operator">?</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Apartment</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> unit<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>unit<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>unit <span class="token operator">=</span> unit <span class="token punctuation">}</span>
    <span class="token keyword">var</span> tenant<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Apartment </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">unit</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>每一个 <code>Person</code> 实例有一个类型为 <code>String</code>，名字为 <code>name</code> 的属性，并有一个可选的初始化为 <code>nil</code> 的 <code>apartment</code> 属性。<code>apartment</code> 属性是可选的，因为一个人并不总是拥有公寓。</p> <p>类似的，每个 <code>Apartment</code> 实例有一个叫 <code>unit</code>，类型为 <code>String</code> 的属性，并有一个可选的初始化为 <code>nil</code> 的 <code>tenant</code> 属性。<code>tenant</code> 属性是可选的，因为一栋公寓并不总是有居民。</p> <p>这两个类都定义了析构器，在类实例被析构的时候输出信息。这让你能够知晓 <code>Person</code> 和 <code>Apartment</code> 的实例是否像预期的那样被销毁。</p> <p>接下来的代码片段定义了两个可选类型的变量 <code>john</code> 和 <code>unit4A</code>，并分别被设为下面的 <code>Apartment</code> 和 <code>Person</code> 的实例。这两个变量都被初始化为 <code>nil</code>，这正是可选类型的优点：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> john<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
<span class="token keyword">var</span> unit4A<span class="token punctuation">:</span> <span class="token class-name">Apartment</span><span class="token operator">?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在你可以创建特定的 <code>Person</code> 和 <code>Apartment</code> 实例并将赋值给 <code>john</code> 和 <code>unit4A</code> 变量：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>john <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;John Appleseed&quot;</span></span><span class="token punctuation">)</span>
unit4A <span class="token operator">=</span> <span class="token class-name">Apartment</span><span class="token punctuation">(</span>unit<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;4A&quot;</span></span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在两个实例被创建和赋值后，下图表现了强引用的关系。变量 <code>john</code> 现在有一个指向 <code>Person</code> 实例的强引用，而变量 <code>unit4A</code> 有一个指向 <code>Apartment</code> 实例的强引用：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110149.png" alt="img"></p> <p>现在你能够将这两个实例关联在一起，这样人就能有公寓住了，而公寓也有了房客。注意感叹号是用来解包和访问可选变量 <code>john</code> 和 <code>unit4A</code> 中的实例，这样实例的属性才能被赋值：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>john<span class="token operator">!</span><span class="token punctuation">.</span>apartment <span class="token operator">=</span> unit4A
unit4A<span class="token operator">!</span><span class="token punctuation">.</span>tenant <span class="token operator">=</span> john
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在将两个实例联系在一起之后，强引用的关系如图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110202.png" alt="img"></p> <p>不幸的是，这两个实例关联后会产生一个循环强引用。<code>Person</code> 实例现在有了一个指向 <code>Apartment</code> 实例的强引用，而 <code>Apartment</code> 实例也有了一个指向 <code>Person</code> 实例的强引用。因此，当你断开 <code>john</code> 和 <code>unit4A</code> 变量所持有的强引用时，引用计数并不会降为 <code>0</code>，实例也不会被 ARC 销毁：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>john <span class="token operator">=</span> <span class="token nil constant">nil</span>
unit4A <span class="token operator">=</span> <span class="token nil constant">nil</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注意，当你把这两个变量设为 <code>nil</code> 时，没有任何一个析构器被调用。循环强引用会一直阻止 <code>Person</code> 和 <code>Apartment</code> 类实例的销毁，这就在你的应用程序中造成了内存泄漏。</p> <p>在你将 <code>john</code> 和 <code>unit4A</code> 赋值为 <code>nil</code> 后，强引用关系如下图：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110226.png" alt="img"></p> <p><code>Person</code> 和 <code>Apartment</code> 实例之间的强引用关系保留了下来并且不会被断开。</p> <h2 id="解决实例之间的循环强引用"><a href="#解决实例之间的循环强引用" class="header-anchor">#</a> 解决实例之间的循环强引用</h2> <p>Swift 提供了两种办法用来解决你在使用类的属性时所遇到的循环强引用问题：弱引用（weak reference）和无主引用（unowned reference）。</p> <p>弱引用和无主引用允许循环引用中的一个实例引用另一个实例而<em>不</em>保持强引用。这样实例能够互相引用而不产生循环强引用。</p> <p>当其他的实例有更短的生命周期时，使用弱引用，也就是说，当其他实例析构在先时。在上面公寓的例子中，很显然一个公寓在它的生命周期内会在某个时间段没有它的主人，所以一个弱引用就加在公寓类里面，避免循环引用。相比之下，当其他实例有相同的或者更长生命周期时，请使用无主引用。</p> <h3 id="弱引用"><a href="#弱引用" class="header-anchor">#</a> 弱引用</h3> <p><em>弱引用</em>不会对其引用的实例保持强引用，因而不会阻止 ARC 销毁被引用的实例。这个特性阻止了引用变为循环强引用。声明属性或者变量时，在前面加上 <code>weak</code> 关键字表明这是一个弱引用。</p> <p>因为弱引用不会保持所引用的实例，即使引用存在，实例也有可能被销毁。因此，ARC 会在引用的实例被销毁后自动将其弱引用赋值为 <code>nil</code>。并且因为弱引用需要在运行时允许被赋值为 <code>nil</code>，所以它们会被定义为可选类型变量，而不是常量。</p> <p>你可以像其他可选值一样，检查弱引用的值是否存在，这样可以避免访问已销毁的实例的引用。</p> <blockquote><p>注意</p> <p>当 ARC 设置弱引用为 <code>nil</code> 时，属性观察不会被触发。</p></blockquote> <p>下面的例子跟上面 <code>Person</code> 和 <code>Apartment</code> 的例子一致，但是有一个重要的区别。这一次，<code>Apartment</code> 的 <code>tenant</code> 属性被声明为弱引用：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name <span class="token punctuation">}</span>
    <span class="token keyword">var</span> apartment<span class="token punctuation">:</span> <span class="token class-name">Apartment</span><span class="token operator">?</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Apartment</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> unit<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>unit<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">self</span><span class="token punctuation">.</span>unit <span class="token operator">=</span> unit <span class="token punctuation">}</span>
    <span class="token keyword">weak</span> <span class="token keyword">var</span> tenant<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Apartment </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">unit</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后跟之前一样，建立两个变量（<code>john</code> 和 <code>unit4A</code>）之间的强引用，并关联两个实例：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> john<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token operator">?</span>
<span class="token keyword">var</span> unit4A<span class="token punctuation">:</span> <span class="token class-name">Apartment</span><span class="token operator">?</span>


john <span class="token operator">=</span> <span class="token class-name">Person</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;John Appleseed&quot;</span></span><span class="token punctuation">)</span>
unit4A <span class="token operator">=</span> <span class="token class-name">Apartment</span><span class="token punctuation">(</span>unit<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;4A&quot;</span></span><span class="token punctuation">)</span>


john<span class="token operator">!</span><span class="token punctuation">.</span>apartment <span class="token operator">=</span> unit4A
unit4A<span class="token operator">!</span><span class="token punctuation">.</span>tenant <span class="token operator">=</span> john
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>现在，两个关联在一起的实例的引用关系如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110326.png" alt="img"></p> <p><code>Person</code> 实例依然保持对 <code>Apartment</code> 实例的强引用，但是 <code>Apartment</code> 实例只持有对 <code>Person</code> 实例的弱引用。这意味着当你通过把 <code>john</code> 变量赋值为 <code>nil</code> 而断开其所保持的强引用时，再也没有指向 <code>Person</code> 实例的强引用了：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>john <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token comment">// 打印“John Appleseed is being deinitialized”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>由于再也没有指向 <code>Person</code> 实例的强引用，该实例会被销毁，且 <code>tenant</code> 属性会被赋值为 <code>nil</code>：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110348.png" alt="img"></p> <p>唯一剩下的指向 <code>Apartment</code> 实例的强引用来自于变量 <code>unit4A</code>。如果你断开这个强引用，再也没有指向 <code>Apartment</code> 实例的强引用了：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>unit4A <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token comment">// 打印“Apartment 4A is being deinitialized”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>由于再也没有指向 <code>Person</code> 实例的强引用，该实例会被销毁：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110410.png" alt="img"></p> <blockquote><p>注意</p> <p>在使用垃圾收集的系统里，弱指针有时用来实现简单的缓冲机制，因为没有强引用的对象只会在内存压力触发垃圾收集时才被销毁。但是在 ARC 中，一旦值的最后一个强引用被移除，就会被立即销毁，这导致弱引用并不适合上面的用途。</p></blockquote> <h3 id="无主引用"><a href="#无主引用" class="header-anchor">#</a> 无主引用</h3> <p>和弱引用类似，<em>无主引用</em>不会牢牢保持住引用的实例。和弱引用不同的是，无主引用在其他实例有相同或者更长的生命周期时使用。你可以在声明属性或者变量时，在前面加上关键字 <code>unowned</code> 表示这是一个无主引用。</p> <p>无主引用通常都被期望拥有值。不过 ARC 无法在实例被销毁后将无主引用设为 <code>nil</code>，因为非可选类型的变量不允许被赋值为 <code>nil</code>。</p> <blockquote><p>重点</p> <p>使用无主引用，你<em>必须</em>确保引用始终指向一个未销毁的实例。</p> <p>如果你试图在实例被销毁后，访问该实例的无主引用，会触发运行时错误。</p></blockquote> <p>下面的例子定义了两个类，<code>Customer</code> 和 <code>CreditCard</code>，模拟了银行客户和客户的信用卡。这两个类中，每一个都将另外一个类的实例作为自身的属性。这种关系可能会造成循环强引用。</p> <p><code>Customer</code> 和 <code>CreditCard</code> 之间的关系与前面弱引用例子中 <code>Apartment</code> 和 <code>Person</code> 的关系略微不同。在这个数据模型中，一个客户可能有或者没有信用卡，但是一张信用卡总是关联着一个客户。为了表示这种关系，<code>Customer</code> 类有一个可选类型的 <code>card</code> 属性，但是 <code>CreditCard</code> 类有一个非可选类型的 <code>customer</code> 属性。</p> <p>此外，只能通过将一个 <code>number</code> 值和 <code>customer</code> 实例传递给 <code>CreditCard</code> 构造器的方式来创建 <code>CreditCard</code> 实例。这样可以确保当创建 <code>CreditCard</code> 实例时总是有一个 <code>customer</code> 实例与之关联。</p> <p>由于信用卡总是关联着一个客户，因此将 <code>customer</code> 属性定义为无主引用，用以避免循环强引用：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> card<span class="token punctuation">:</span> <span class="token class-name">CreditCard</span><span class="token operator">?</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token punctuation">}</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">CreditCard</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> number<span class="token punctuation">:</span> <span class="token class-name">UInt64</span>
    <span class="token keyword">unowned</span> <span class="token keyword">let</span> customer<span class="token punctuation">:</span> <span class="token class-name">Customer</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token class-name">UInt64</span><span class="token punctuation">,</span> customer<span class="token punctuation">:</span> <span class="token class-name">Customer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>number <span class="token operator">=</span> number
        <span class="token keyword">self</span><span class="token punctuation">.</span>customer <span class="token operator">=</span> customer
    <span class="token punctuation">}</span>
    <span class="token keyword">deinit</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Card #</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">number</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>注意</p> <p><code>CreditCard</code> 类的 <code>number</code> 属性被定义为 <code>UInt64</code> 类型而不是 <code>Int</code> 类型，以确保 <code>number</code> 属性的存储量在 32 位和 64 位系统上都能足够容纳 16 位的卡号。</p></blockquote> <p>下面的代码片段定义了一个叫 <code>john</code> 的可选类型 <code>Customer</code> 变量，用来保存某个特定客户的引用。由于是可选类型，所以变量被初始化为 <code>nil</code>：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> john<span class="token punctuation">:</span> <span class="token class-name">Customer</span><span class="token operator">?</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在你可以创建 <code>Customer</code> 类的实例，用它初始化 <code>CreditCard</code> 实例，并将新创建的 <code>CreditCard</code> 实例赋值为客户的 <code>card</code> 属性：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>john <span class="token operator">=</span> <span class="token class-name">Customer</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;John Appleseed&quot;</span></span><span class="token punctuation">)</span>
john<span class="token operator">!</span><span class="token punctuation">.</span>card <span class="token operator">=</span> <span class="token class-name">CreditCard</span><span class="token punctuation">(</span>number<span class="token punctuation">:</span> <span class="token number">1234_5678_9012_3456</span><span class="token punctuation">,</span> customer<span class="token punctuation">:</span> john<span class="token operator">!</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在你关联两个实例后，它们的引用关系如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110444.png" alt="img"></p> <p><code>Customer</code> 实例持有对 <code>CreditCard</code> 实例的强引用，而 <code>CreditCard</code> 实例持有对 <code>Customer</code> 实例的无主引用。</p> <p>由于 <code>customer</code> 的无主引用，当你断开 <code>john</code> 变量持有的强引用时，再也没有指向 <code>Customer</code> 实例的强引用了：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110453.png" alt="img"></p> <p>由于再也没有指向 <code>Customer</code> 实例的强引用，该实例被销毁了。其后，再也没有指向 <code>CreditCard</code> 实例的强引用，该实例也随之被销毁了：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>john <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token comment">// 打印“John Appleseed is being deinitialized”</span>
<span class="token comment">// 打印“Card #1234567890123456 is being deinitialized”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最后的代码展示了在 <code>john</code> 变量被设为 <code>nil</code> 后 <code>Customer</code> 实例和 <code>CreditCard</code> 实例的析构器都打印出了“销毁”的信息。</p> <blockquote><p>注意</p> <p>上面的例子展示了如何使用安全的无主引用。对于需要禁用运行时的安全检查的情况（例如，出于性能方面的原因），Swift 还提供了不安全的无主引用。与所有不安全的操作一样，你需要负责检查代码以确保其安全性。 你可以通过 <code>unowned(unsafe)</code> 来声明不安全无主引用。如果你试图在实例被销毁后，访问该实例的不安全无主引用，你的程序会尝试访问该实例之前所在的内存地址，这是一个不安全的操作。</p></blockquote> <h3 id="无主引用和隐式解包可选值属性"><a href="#无主引用和隐式解包可选值属性" class="header-anchor">#</a> 无主引用和隐式解包可选值属性</h3> <p>上面弱引用和无主引用的例子涵盖了两种常用的需要打破循环强引用的场景。</p> <p><code>Person</code> 和 <code>Apartment</code> 的例子展示了两个属性的值都允许为 <code>nil</code>，并会潜在的产生循环强引用。这种场景最适合用弱引用来解决。</p> <p><code>Customer</code> 和 <code>CreditCard</code> 的例子展示了一个属性的值允许为 <code>nil</code>，而另一个属性的值不允许为 <code>nil</code>，这也可能会产生循环强引用。这种场景最适合通过无主引用来解决。</p> <p>然而，存在着第三种场景，在这种场景中，两个属性都必须有值，并且初始化完成后永远不会为 <code>nil</code>。在这种场景中，需要一个类使用无主属性，而另外一个类使用隐式解包可选值属性。</p> <p>这使两个属性在初始化完成后能被直接访问（不需要可选解包），同时避免了循环引用。这一节将为你展示如何建立这种关系。</p> <p>下面的例子定义了两个类，<code>Country</code> 和 <code>City</code>，每个类将另外一个类的实例保存为属性。在这个模型中，每个国家必须有首都，每个城市必须属于一个国家。为了实现这种关系，<code>Country</code> 类拥有一个 <code>capitalCity</code> 属性，而 <code>City</code> 类有一个 <code>country</code> 属性：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">Country</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">var</span> capitalCity<span class="token punctuation">:</span> <span class="token class-name">City</span><span class="token operator">!</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> capitalName<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>capitalCity <span class="token operator">=</span> <span class="token class-name">City</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> capitalName<span class="token punctuation">,</span> country<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">City</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">unowned</span> <span class="token keyword">let</span> country<span class="token punctuation">:</span> <span class="token class-name">Country</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> country<span class="token punctuation">:</span> <span class="token class-name">Country</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>country <span class="token operator">=</span> country
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>为了建立两个类的依赖关系，<code>City</code> 的构造器接受一个 <code>Country</code> 实例作为参数，并且将实例保存到 <code>country</code> 属性。</p> <p><code>Country</code> 的构造器调用了 <code>City</code> 的构造器。然而，只有 <code>Country</code> 的实例完全初始化后，<code>Country</code> 的构造器才能把 <code>self</code> 传给 <code>City</code> 的构造器。在 <a href="/pages/1b072a/#两段式构造过程">两段式构造过程</a> 中有具体描述。</p> <p>为了满足这种需求，通过在类型结尾处加上感叹号（<code>City!</code>）的方式，将 <code>Country</code> 的 <code>capitalCity</code> 属性声明为隐式解包可选值类型的属性。这意味着像其他可选类型一样，<code>capitalCity</code> 属性的默认值为 <code>nil</code>，但是不需要解包它的值就能访问它。在 <a href="/pages/9e2f81/#隐式解析可选类型">隐式解析可选类型</a> 中有描述。</p> <p>由于 <code>capitalCity</code> 默认值为 <code>nil</code>，一旦 <code>Country</code> 的实例在构造器中给 <code>name</code> 属性赋值后，整个初始化过程就完成了。这意味着一旦 <code>name</code> 属性被赋值后，<code>Country</code> 的构造器就能引用并传递隐式的 <code>self</code>。<code>Country</code> 的构造器在赋值 <code>capitalCity</code> 时，就能将 <code>self</code> 作为参数传递给 <code>City</code> 的构造器。</p> <p>上述的意义在于你可以通过一条语句同时创建 <code>Country</code> 和 <code>City</code> 的实例，而不产生循环强引用，并且 <code>capitalCity</code> 的属性能被直接访问，而不需要通过感叹号来解包它的可选值：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> country <span class="token operator">=</span> <span class="token class-name">Country</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Canada&quot;</span></span><span class="token punctuation">,</span> capitalName<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Ottawa&quot;</span></span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">country<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">'s capital city is called </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">country<span class="token punctuation">.</span>capitalCity<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span>
<span class="token comment">// 打印“Canada's capital city is called Ottawa”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在上面的例子中，使用隐式解包可选值值意味着满足了类的构造器的两个构造阶段的要求。<code>capitalCity</code> 属性在初始化完成后，能像非可选值一样使用和存取，同时还避免了循环强引用。</p> <h2 id="闭包的循环强引用"><a href="#闭包的循环强引用" class="header-anchor">#</a> 闭包的循环强引用</h2> <p>前面我们看到了循环强引用是在两个类实例属性互相保持对方的强引用时产生的，还知道了如何用弱引用和无主引用来打破这些循环强引用。</p> <p>循环强引用还会发生在当你将一个闭包赋值给类实例的某个属性，并且这个闭包体中又使用了这个类实例时。这个闭包体中可能访问了实例的某个属性，例如 <code>self.someProperty</code>，或者闭包中调用了实例的某个方法，例如 <code>self.someMethod()</code>。这两种情况都导致了闭包“捕获”<code>self</code>，从而产生了循环强引用。</p> <p>循环强引用的产生，是因为闭包和类相似，都是引用类型。当你把一个闭包赋值给某个属性时，你是将这个闭包的引用赋值给了属性。实质上，这跟之前的问题是一样的——两个强引用让彼此一直有效。但是，和两个类实例不同，这次一个是类实例，另一个是闭包。</p> <p>Swift 提供了一种优雅的方法来解决这个问题，称之为 <code>闭包捕获列表</code>（closure capture list）。同样的，在学习如何用闭包捕获列表打破循环强引用之前，先来了解一下这里的循环强引用是如何产生的，这对我们很有帮助。</p> <p>下面的例子为你展示了当一个闭包引用了 <code>self</code> 后是如何产生一个循环强引用的。例子中定义了一个叫 <code>HTMLElement</code> 的类，用一种简单的模型表示 HTML 文档中的一个单独的元素：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>


    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">let</span> text<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span>


    <span class="token keyword">lazy</span> <span class="token keyword">var</span> asHTML<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>text <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;&lt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&gt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">text</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&lt;/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&gt;&quot;</span></span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;&lt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> /&gt;&quot;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text
    <span class="token punctuation">}</span>


    <span class="token keyword">deinit</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p><code>HTMLElement</code> 类定义了一个 <code>name</code> 属性来表示这个元素的名称，例如代表头部元素的 <code>&quot;h1&quot;</code>，代表段落的 <code>&quot;p&quot;</code>，或者代表换行的 <code>&quot;br&quot;</code>。<code>HTMLElement</code> 还定义了一个可选属性 <code>text</code>，用来设置 HTML 元素呈现的文本。</p> <p>除了上面的两个属性，<code>HTMLElement</code> 还定义了一个 <code>lazy</code> 属性 <code>asHTML</code>。这个属性引用了一个将 <code>name</code> 和 <code>text</code> 组合成 HTML 字符串片段的闭包。该属性是 <code>Void -&gt; String</code> 类型，或者可以理解为“一个没有参数，返回 <code>String</code> 的函数”。</p> <p>默认情况下，闭包赋值给了 <code>asHTML</code> 属性，这个闭包返回一个代表 HTML 标签的字符串。如果 <code>text</code> 值存在，该标签就包含可选值 <code>text</code>；如果 <code>text</code> 不存在，该标签就不包含文本。对于段落元素，根据 <code>text</code> 是 <code>&quot;some text&quot;</code> 还是 <code>nil</code>，闭包会返回 <code>&quot;&lt;p&gt;some text&lt;/p&gt;&quot;</code> 或者 <code>&quot;&lt;p /&gt;&quot;</code>。</p> <p>可以像实例方法那样去命名、使用 <code>asHTML</code> 属性。然而，由于 <code>asHTML</code> 是闭包而不是实例方法，如果你想改变特定 HTML 元素的处理方式的话，可以用自定义的闭包来取代默认值。</p> <p>例如，可以将一个闭包赋值给 <code>asHTML</code> 属性，这个闭包能在 <code>text</code> 属性是 <code>nil</code> 时使用默认文本，这是为了避免返回一个空的 HTML 标签：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">let</span> heading <span class="token operator">=</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;h1&quot;</span></span><span class="token punctuation">)</span>
<span class="token keyword">let</span> defaultText <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;some default text&quot;</span></span>
heading<span class="token punctuation">.</span>asHTML <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;&lt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">heading<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&gt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">heading<span class="token punctuation">.</span>text <span class="token operator">??</span> defaultText</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&lt;/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">heading<span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&gt;&quot;</span></span>
<span class="token punctuation">}</span>
<span class="token function">print</span><span class="token punctuation">(</span>heading<span class="token punctuation">.</span><span class="token function">asHTML</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 打印“&lt;h1&gt;some default text&lt;/h1&gt;”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>注意</p> <p><code>asHTML</code> 声明为 <code>lazy</code> 属性，因为只有当元素确实需要被处理为 HTML 输出的字符串时，才需要使用 <code>asHTML</code>。也就是说，在默认的闭包中可以使用 <code>self</code>，因为只有当初始化完成以及 <code>self</code> 确实存在后，才能访问 <code>lazy</code> 属性。</p></blockquote> <p><code>HTMLElement</code> 类只提供了一个构造器，通过 <code>name</code> 和 <code>text</code>（如果有的话）参数来初始化一个新元素。该类也定义了一个析构器，当 <code>HTMLElement</code> 实例被销毁时，打印一条消息。</p> <p>下面的代码展示了如何用 <code>HTMLElement</code> 类创建实例并打印消息：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> paragraph<span class="token punctuation">:</span> <span class="token class-name">HTMLElement</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;p&quot;</span></span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;hello, world&quot;</span></span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>paragraph<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">asHTML</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 打印“&lt;p&gt;hello, world&lt;/p&gt;”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>注意</p> <p>上面的 <code>paragraph</code> 变量定义为可选类型的 <code>HTMLElement</code>，因此我们可以赋值 <code>nil</code> 给它来演示循环强引用。</p></blockquote> <p>不幸的是，上面写的 <code>HTMLElement</code> 类产生了类实例和作为 <code>asHTML</code> 默认值的闭包之间的循环强引用。循环强引用如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110506.png" alt="img"></p> <p>实例的 <code>asHTML</code> 属性持有闭包的强引用。但是，闭包在其闭包体内使用了 <code>self</code>（引用了 <code>self.name</code> 和 <code>self.text</code>），因此闭包捕获了 <code>self</code>，这意味着闭包又反过来持有了 <code>HTMLElement</code> 实例的强引用。这样两个对象就产生了循环强引用。（更多关于闭包捕获值的信息，请参考 <a href="/pages/7904a7/#值捕获">值捕获</a>）。</p> <blockquote><p>注意</p> <p>虽然闭包多次使用了 <code>self</code>，它只捕获 <code>HTMLElement</code> 实例的一个强引用。</p></blockquote> <p>如果设置 <code>paragraph</code> 变量为 <code>nil</code>，打破它持有的 <code>HTMLElement</code> 实例的强引用，<code>HTMLElement</code> 实例和它的闭包都不会被销毁，也是因为循环强引用：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>paragraph <span class="token operator">=</span> <span class="token nil constant">nil</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意，<code>HTMLElement</code> 的析构器中的消息并没有被打印，证明了 <code>HTMLElement</code> 实例并没有被销毁。</p> <h2 id="解决闭包的循环强引用"><a href="#解决闭包的循环强引用" class="header-anchor">#</a> 解决闭包的循环强引用</h2> <p>在定义闭包时同时定义捕获列表作为闭包的一部分，通过这种方式可以解决闭包和类实例之间的循环强引用。捕获列表定义了闭包体内捕获一个或者多个引用类型的规则。跟解决两个类实例间的循环强引用一样，声明每个捕获的引用为弱引用或无主引用，而不是强引用。应当根据代码关系来决定使用弱引用还是无主引用。</p> <blockquote><p>注意</p> <p>Swift 有如下要求：只要在闭包内使用 <code>self</code> 的成员，就要用 <code>self.someProperty</code> 或者 <code>self.someMethod()</code>（而不只是 <code>someProperty</code> 或 <code>someMethod()</code>）。这提醒你可能会一不小心就捕获了 <code>self</code>。</p></blockquote> <h3 id="定义捕获列表"><a href="#定义捕获列表" class="header-anchor">#</a> 定义捕获列表</h3> <p>捕获列表中的每一项都由一对元素组成，一个元素是 <code>weak</code> 或 <code>unowned</code> 关键字，另一个元素是类实例的引用（例如 <code>self</code>）或初始化过的变量（如 <code>delegate = self.delegate</code>）。这些项在方括号中用逗号分开。</p> <p>如果闭包有参数列表和返回类型，把捕获列表放在它们前面：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">lazy</span> <span class="token keyword">var</span> someClosure <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">unowned</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">weak</span> delegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>delegate<span class="token punctuation">]</span>
    <span class="token punctuation">(</span>index<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">,</span> stringToProcess<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span> <span class="token keyword">in</span>
    <span class="token comment">// 这里是闭包的函数体</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果闭包没有指明参数列表或者返回类型，它们会通过上下文推断，那么可以把捕获列表和关键字 <code>in</code> 放在闭包最开始的地方：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">lazy</span> <span class="token keyword">var</span> someClosure <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">unowned</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token keyword">weak</span> delegate <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>delegate<span class="token punctuation">]</span> <span class="token keyword">in</span>
    <span class="token comment">// 这里是闭包的函数体</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="弱引用和无主引用"><a href="#弱引用和无主引用" class="header-anchor">#</a> 弱引用和无主引用</h3> <p>在闭包和捕获的实例总是互相引用并且总是同时销毁时，将闭包内的捕获定义为 <code>无主引用</code>。</p> <p>相反的，在被捕获的引用可能会变为 <code>nil</code> 时，将闭包内的捕获定义为 <code>弱引用</code>。弱引用总是可选类型，并且当引用的实例被销毁后，弱引用的值会自动置为 <code>nil</code>。这使我们可以在闭包体内检查它们是否存在。</p> <blockquote><p>注意</p> <p>如果被捕获的引用绝对不会变为 <code>nil</code>，应该用无主引用，而不是弱引用。</p></blockquote> <p>前面的 <code>HTMLElement</code> 例子中，无主引用是正确的解决循环强引用的方法。这样编写 <code>HTMLElement</code> 类来避免循环强引用：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">class</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>


    <span class="token keyword">let</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span>
    <span class="token keyword">let</span> text<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span>


    <span class="token keyword">lazy</span> <span class="token keyword">var</span> asHTML<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token keyword">unowned</span> <span class="token keyword">self</span><span class="token punctuation">]</span> <span class="token keyword">in</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> text <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>text <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;&lt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&gt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">text</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&lt;/</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&gt;&quot;</span></span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string-literal"><span class="token string">&quot;&lt;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation"><span class="token keyword">self</span><span class="token punctuation">.</span>name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> /&gt;&quot;</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>text <span class="token operator">=</span> text
    <span class="token punctuation">}</span>


    <span class="token keyword">deinit</span> <span class="token punctuation">{</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;</span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">name</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string"> is being deinitialized&quot;</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>上面的 <code>HTMLElement</code> 实现和之前的实现一致，除了在 <code>asHTML</code> 闭包中多了一个捕获列表。这里，捕获列表是 <code>[unowned self]</code>，表示“将 <code>self</code> 捕获为无主引用而不是强引用”。</p> <p>和之前一样，我们可以创建并打印 <code>HTMLElement</code> 实例：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">var</span> paragraph<span class="token punctuation">:</span> <span class="token class-name">HTMLElement</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token class-name">HTMLElement</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;p&quot;</span></span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;hello, world&quot;</span></span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>paragraph<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">asHTML</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 打印“&lt;p&gt;hello, world&lt;/p&gt;”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用捕获列表后引用关系如下图所示：</p> <p><img src="https://cdn.jsdelivr.net/gh/zhmbo/static@master/img/20201111110535.png" alt="img"></p> <p>这一次，闭包以无主引用的形式捕获 <code>self</code>，并不会持有 <code>HTMLElement</code> 实例的强引用。如果将 <code>paragraph</code> 赋值为 <code>nil</code>，<code>HTMLElement</code> 实例将会被销毁，并能看到它的析构器打印出的消息：</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>paragraph <span class="token operator">=</span> <span class="token nil constant">nil</span>
<span class="token comment">// 打印“p is being deinitialized”</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>你可以查看 <a href="/pages/c2fef9/#捕获列表">捕获列表</a> 章节，获取更多关于捕获列表的信息。</p></div></div> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/07/30, 18:07:00</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/46ff18/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">不透明类型</div></a> <a href="/pages/9224f8/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">内存安全</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/46ff18/" class="prev">不透明类型</a></span> <span class="next"><a href="/pages/9224f8/">内存安全</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/742912/"><div>Homebrew+RVM+Ruby+CocoaPods</div></a> <span>11-23</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/81af2e/"><div>iOS13生命周期</div></a> <span>11-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/258164/"><div>《Swift编程语言》- 语法总结</div></a> <span>11-11</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div> <div class="comments-wrapper"><!----></div> </main></div> <!----> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;filter:grayscale(100%);"></div> <!----> <div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f91ba302.js" defer></script><script src="/assets/js/2.dd713b59.js" defer></script><script src="/assets/js/3.069de0ac.js" defer></script><script src="/assets/js/36.ef1f9b0b.js" defer></script>
  </body>
</html>